<!DOCTYPE html>
<html lang="ch">
  <head>
    <meta charset="utf-8">
    <title>引力学数值模拟</title>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery-1.9.1.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="http://jqueryui.com/resources/demos/style.css">
    <!--script src=”http://libs.baidu.com/jquery/2.1.1/jquery.min.js”></script-->
    <!--script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script-->
  </head>
  <body>
    
    <h1>引力学数值模拟</h1>
    
    <p>我儿子又在看我编程了</p>
    
    <canvas id="box" width="400" height="400" style="border: 1px solid #000000">
      您的浏览器未支持HTML5 canvas控件
    </canvas>
    
    <br/>
    <span>质量：</span>
    <div id="slideMass"></div>
    
    <br/>
    <span>速率：</span>
    <div id="slideSpeed"></div>
    
    <script>
function Vector(x, y, z) {
 this.x = x;
 this.y = y;
 this.z = z;
}

Vector.prototype = {
 copy: function() {
  return new Vector(this.x, this.y, this.z);
 },
 negate: function() {
  return new Vector(-this.x, -this.y, -this.z);
 },
 add: function(other) {
  return new Vector(this.x + other.x, this.y + other.y, this.z + other.z);
 },
 subtract: function(other) {
  return new Vector(this.x - other.x, this.y - other.y, this.z - other.z);
 },
 multiply: function(other) {
  return new Vector(this.x * other, this.y * other, this.z * other);
 },
 divide: function(other) {
  return new Vector(this.x / other, this.y / other, this.z / other);
 },
 negateUp: function(other) {
  this.x = -this.x;
  this.y = -this.y;
  this.z = -this.z;
  return this;
 },
 addUp: function(other) {
  this.x += other.x;
  this.y += other.y;
  this.z += other.z;
  return this;
 },
 subtractUp: function(other) {
  this.x -= other.x;
  this.y -= other.y;
  this.z -= other.z;
  return this;
 },
 multiplyUp: function(other) {
  this.x *= other;
  this.y *= other;
  this.z *= other;
  return this;
 },
 divideUp: function(other) {
  this.x /= other;
  this.y /= other;
  this.z /= other;
  return this;
 },
 dotProduct: function(other) {
  return this.x * other.x + this.y * other.y + this.z * other.z;
 },
 crossProduct: function(other) {
  return new Vector(this.y * other.z - this.z * other.y, this.z * other.x - this.x * other.z, this.x * other.y - this.y * other.x);
 },
 length: function() {
  return Math.sqrt(dotProduct(this));
 },
 normalize: function() {
  return divide(length());
 },
 normalizeUp: function() {
  return divideUp(length());
 },
 toString: function() {
  return '(' + this.x + ',' + this.y + ',' + this.z + ')';
 },
};

function zeroVector() {
 return new Vector(0, 0, 0);
}

    </script><script>

function Ball(position, velocity, mass) {
 this.position = position;
 this.velocity = velocity;
 this.mass = mass;
 mass = Math.abs(mass);
 if (mass > 1)
  mass = Math.log(mass);
 else
  mass = 0;
 this.radius = 1 + 0.15 * mass * Math.sqrt(mass);
}

Ball.prototype = {
 moveByTime: function(timePassed) {
  this.position.addUp(this.velocity.multiply(timePassed));
 },
 accelerateByTime: function(timePassed, acceleration) {
  this.velocity.addUp(acceleration.multiply(timePassed));
 },
};

    </script><script>

function fillCircle(ctx, x, y, r) {
 ctx.beginPath();
 ctx.arc(x, y, r, 0, 2 * Math.PI);
 ctx.fill();
}

function drawArrow(ctx, x0, y0, dx, dy) {
 ctx.moveTo(x0, y0);
 ctx.lineTo(x0 + dx, y0 + dy);
 ctx.lineTo(x0 + 0.8 * dx - 0.2 * dy, y0 + 0.8 * dy + 0.2 * dx);
 ctx.moveTo(x0 + dx, y0 + dy);
 ctx.lineTo(x0 + 0.8 * dx + 0.2 * dy, y0 + 0.8 * dy - 0.2 * dx);
 ctx.stroke();
}

    </script><script>

var box = document.getElementById('box');
var ctx = box.getContext('2d');

var screenX = box.width;
var screenY = box.height;

var screenScale = {x: box.height / 80, y: -box.width / 80};

function screenOrtho(position) {
 var x = position.x * screenScale.x + screenX / 2;
 var y = position.y * screenScale.y + screenY / 2;
 return {x: x, y: y};
}

function screenUnortho(position) {
 var x = (position.x - screenX / 2) / screenScale.x;
 var y = (position.y - screenY / 2) / screenScale.y;
 return new Vector(x, y, 0);
}

Ball.prototype.render = function(ctx) {
 var xy = screenOrtho(this.position);
 ctx.fillStyle = '#FF8800';
 ctx.strokeStyle = '#AA5500';
 var radius = this.radius;
 fillCircle(ctx, xy.x, xy.y, radius);
}

function renderField(ctx, field, x0, y0, z0, x1, y1, z1, dx, dy, dz) {
 ctx.strokeStyle = '#558888';
 var scale = 0.3;
 for (var y = y0; y <= y1; y += dy) {
  for (var x = x0; x <= x1; x += dx) {
   //for (var z = z0; z <= z1; z += dz) {
    var z = 0;
    var position = new Vector(x, y, z);
    var v = field(position);
    var xy = screenOrtho(position);
    var ovx = v.x * screenScale.x * scale;
    var ovy = v.y * screenScale.y * scale;
    if (ovx * ovx + ovy * ovy > 1500)
     continue;
    drawArrow(ctx, xy.x, xy.y, ovx, ovy);
   //}
  }
 }
}

var world = new Array();
var worldOnce = false;
var needRenderField = false;
	

/**** world selectors ****/
function world1() {
world[0] = new Ball(new Vector(0, 0, 0), new Vector(0, 0, 0), 1000);
world[1] = new Ball(new Vector(10, 0, 0), new Vector(0, 9, 0), 0);
world[2] = new Ball(new Vector(0, 20, 0), new Vector(-4.5, 0, 0), 0);
}

function world2() {
worldOnce = true;
world[0] = new Ball(new Vector(18, 0, 0), new Vector(0, 0, 0), 1000);
world[1] = new Ball(new Vector(-18, 0, 0), new Vector(0, 0, 0), -250);
}

function world3() {
world[0] = new Ball(new Vector(0, 0, 0), new Vector(2, 0, 0), 1800);
world[1] = new Ball(new Vector(0, 18, 0), new Vector(-9, 0, 0), 400);
world[2] = new Ball(new Vector(2, 18, 0), new Vector(-9, 13, 0), 0);
}

function world4() {
worldOnce = true;
world[0] = new Ball(new Vector(20, 0, 0), new Vector(0, 0, 0), 800);
world[1] = new Ball(new Vector(-20, 0, 0), new Vector(0, 0, 0), -800);
}

world3(); /* select here */
/*************************/

//var ball = world[0];/**/

/*var ball = new Ball(new Vector(10, 0, 0), new Vector(0, 3, 0));*/

var dteInterval = 0.02;
var renderFieldInterval = 0.1;
var renderFieldClock = 0;

function awlg(message) {
 //document.write(message);
 //console.log(message);
 alert(message);
}

//awlg('dbgmdok');

function coolFunction(distant) {
 var distanceSquared = distant.dotProduct(distant);
 if (distanceSquared <= 0.00001)
  return zeroVector();
 var distanceCubed = distanceSquared * Math.sqrt(distanceSquared);
 return distant.divide(distanceCubed);
}

function getFieldAt(position, excluded) {
 var acceleration = zeroVector();
 for (var i in world) {
  if (i === excluded)
   continue;
  var other = world[i];
  if (other.mass === 0)
   continue;
  var distant = other.position.subtract(position);
  var accOnce = coolFunction(distant);
  accOnce.multiplyUp(other.mass);
  acceleration.addUp(accOnce);
 }
 return acceleration;
}

function dteMain() {

 //ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
 ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
 ctx.fillRect(0, 0, screenX, screenY);

 timePassed = dteInterval;

 for (var i in world) {
  var ball = world[i];
  ball.render(ctx);
  ball.moveByTime(timePassed);
  var acceleration = getFieldAt(ball.position, i);
  ball.accelerateByTime(timePassed, acceleration);
 }

 var scax = 35;
 var scay = 35;
 if (needRenderField && (renderFieldClock -= timePassed) <= 0) {
  renderField(ctx, getFieldAt, -scax, -scay, 0, scax, scay, 0, 5, 5, 100);
  renderFieldClock = renderFieldInterval;
 }
}

    var slideMass = 0;
    var slideSpeed = 1;
    var lastMouse;
    
    function getMouse(e) {
      if (e.layerX || e.layerX == 0) { // Firefox 
        e.target.style.position = 'relative';
        return {x: e.layerX, y: e.layerY};
      } else {
        return {x: e.offsetX, y: e.offsetY};
      }
    }
    
    box.onmousedown = function(e) {
      lastMouse = getMouse(e);
    };
    
    box.onmouseup = function(e) {
      var mouse = getMouse(e);
      
      var position = screenUnortho(mouse);
      var velocity = zeroVector();
      
      if (lastMouse !== undefined) {
        var lastPosition = screenUnortho(lastMouse);
        var speed = slideSpeed;
        velocity = position.subtract(lastPosition).multiply(speed);
      }
      
      var mass = slideMass;
      
      var ball = new Ball(position, velocity, mass);
      world.push(ball);
      
      lastMouse = undefined;
    };

if (worldOnce)
 dteMain();
else
 setInterval(dteMain, dteInterval);

    </script><script>
    
    $(function() {
      $("#slideMass").slider({
        orientation: "horizontal",
        range: "min",
        max: 1000 + 0.0,
        value: slideMass + 0.0,
        //slide: refreshSwatch,
        change: function() {
          slideMass = $(this).slider("value");
        },
      });
      $("#slideSpeed").slider({
        orientation: "horizontal",
        range: "min",
        max: 5 + 0.0,
        value: slideSpeed + 0.0,
        //slide: refreshSwatch,
        change: function() {
          slideSpeed = $(this).slider("value");
        },
      });
    });
                                                                                                                    
    </script>
	
  </body> 
</html>		
